#!/bin/bash
# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ SwapSphere Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ ÑĞµÑ€Ğ²ĞµÑ€Ğµ

echo "ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ SwapSphere..."

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½! Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Docker Ğ¸ Docker Compose."
    exit 1
fi

if ! command -v docker compose &> /dev/null; then
    echo "âŒ Docker Compose Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!"
    exit 1
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
echo "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸..."
mkdir -p ssl
mkdir -p logs
mkdir -p backups

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° .env Ñ„Ğ°Ğ¹Ğ»Ğ°
if [ ! -f .env.production ]; then
    echo "âŒ Ğ¤Ğ°Ğ¹Ğ» .env.production Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!"
    echo "ğŸ“ Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ .env.production Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°."
    exit 1
fi

# ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ env Ñ„Ğ°Ğ¹Ğ»Ğ°
cp .env.production .env

echo "ğŸ“¦ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²..."
docker compose -f docker-compose.yml build

echo "ğŸ—„ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..."
docker compose -f docker-compose.yml up -d db redis

echo "â³ Ğ–Ğ´ĞµĞ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..."
sleep 10

echo "ğŸ”„ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹..."
docker compose -f docker-compose.yml run --rm web python manage.py migrate

echo "ğŸ“Š Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²..."
docker compose -f docker-compose.yml run --rm web python manage.py collectstatic --noinput

echo "ğŸ‘¤ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑÑƒĞ¿ĞµÑ€Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)..."
echo "Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°? (y/n)"
read -r create_admin
if [ "$create_admin" = "y" ]; then
    docker compose -f docker-compose.yml run --rm web python manage.py createsuperuser
fi

echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²..."
docker compose -f docker-compose.yml up -d

echo "âœ… Ğ Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!"
echo "ğŸŒ Ğ’Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ: http://your-domain.ru"
echo "ğŸ”§ ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°: http://your-domain.ru/admin/"

echo "ğŸ“‹ ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:"
echo "  ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ¾Ğ²: docker compose logs -f"
echo "  ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°: docker compose down"
echo "  ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº: docker compose restart"
echo "  Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ¿Ğ¸Ñ Ğ‘Ğ”: docker compose exec db pg_dump -U \$POSTGRES_USER \$POSTGRES_DB > backup.sql"
