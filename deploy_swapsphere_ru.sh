#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è SwapSphere –Ω–∞ –¥–æ–º–µ–Ω–µ swapsphere.ru

echo "üåê –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ SwapSphere –Ω–∞ –¥–æ–º–µ–Ω–µ swapsphere.ru..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root –ø—Ä–∞–≤
if [[ $EUID -eq 0 ]]; then
   echo "‚ùå –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç root! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å sudo."
   exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
if ! command -v docker &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Docker..."
    curl -fsSL https://get.docker.com | sh
    sudo usermod -aG docker $USER
    echo "‚úÖ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞."
    exit 0
fi

if ! command -v docker compose &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Docker Compose..."
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìÅ –°–æ–∑–¥–∞—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
mkdir -p ssl logs backups

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è swapsphere.ru
echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é Nginx –¥–ª—è –¥–æ–º–µ–Ω–∞ swapsphere.ru..."
cp nginx_production.conf nginx.conf

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
cp .env.production .env

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot –¥–ª—è SSL
echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Certbot –¥–ª—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
if command -v apt &> /dev/null; then
    sudo apt update
    sudo apt install -y certbot nginx-full
elif command -v yum &> /dev/null; then
    sudo yum install -y certbot nginx
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
echo "üõ°Ô∏è –ü–æ–ª—É—á–∞—é SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è swapsphere.ru..."
read -p "–•–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Let's Encrypt? (y/n): " get_ssl
if [ "$get_ssl" = "y" ]; then
    sudo certbot certonly --nginx -d swapsphere.ru -d www.swapsphere.ru --non-interactive --agree-tos --email vovapilip46@gmail.com
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    sed -i 's|/etc/ssl/certs/swapsphere.ru.crt|/etc/letsencrypt/live/swapsphere.ru/fullchain.pem|g' nginx.conf
    sed -i 's|/etc/ssl/private/swapsphere.ru.key|/etc/letsencrypt/live/swapsphere.ru/privkey.pem|g' nginx.conf
fi

echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
docker compose -f docker-compose.yml build --no-cache

echo "üóÑÔ∏è –ó–∞–ø—É—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ Redis..."
docker compose -f docker-compose.yml up -d db redis

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (30 —Å–µ–∫)..."
sleep 30

echo "üìä –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
docker compose -f docker-compose.yml run --rm web python manage.py migrate

echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
docker compose -f docker-compose.yml run --rm web python manage.py collectstatic --noinput

echo "üë§ –°–æ–∑–¥–∞–Ω–∏–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
read -p "–°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞? (y/n): " create_admin
if [ "$create_admin" = "y" ]; then
    docker compose -f docker-compose.yml run --rm web python manage.py createsuperuser
fi

echo "üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose -f docker-compose.yml up -d

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SSL
echo "üîÑ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL..."
(crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
echo "üõ°Ô∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é —Ñ–∞–π—Ä–≤–æ–ª..."
if command -v ufw &> /dev/null; then
    sudo ufw --force enable
    sudo ufw allow 22/tcp    # SSH
    sudo ufw allow 80/tcp    # HTTP
    sudo ufw allow 443/tcp   # HTTPS
    sudo ufw reload
fi

echo ""
echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ SwapSphere –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üåê –í–∞—à —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
echo "   ‚Ä¢ https://swapsphere.ru"
echo "   ‚Ä¢ https://www.swapsphere.ru (–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π)"
echo ""
echo "üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:"
echo "   ‚Ä¢ https://swapsphere.ru/admin/"
echo ""
echo "üìß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—á—Ç—ã:"
echo "   ‚Ä¢ SMTP: smtp.reg.ru:587"
echo "   ‚Ä¢ Email: noreply@swapsphere.ru"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   ‚Ä¢ –õ–æ–≥–∏: docker compose logs -f"
echo "   ‚Ä¢ –°—Ç–∞—Ç—É—Å: docker compose ps"
echo "   ‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: docker compose restart"
echo "   ‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∫–∞: docker compose down"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ!"
echo "   –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å DNS, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –¥–æ 24 —á–∞—Å–æ–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è."
